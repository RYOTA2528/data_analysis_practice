// Snowflake REST APIs を使用するときにサーバーに対して認証する方法
リクエストを送信する場合、リクエストには以下のいずれかを使用する認証情報が含まれている必要があります。

キーペア認証の使用

OAuth の使用

※[キーペア認証の使用]こちらを使用


ステップ①：キーペア認証を設定する
このプロセスの一環として、次を実行する必要があります。

1.公開キーと秘密キーのペアを生成します。生成された秘密キーはファイル内にある必要があります（例: rsa_key.p8 という名前）。

2.公開キーをSnowflakeユーザーに割り当てます。ユーザーにキーを割り当てたら、 DESCRIBE USER コマンドを実行します。出力では、 RSA_PUBLIC_KEY_FP プロパティは、ユーザーに割り当てられた公開キーのフィンガープリントに設定する必要があります。


---------------------------【1.2のために秘密鍵・公開鍵の設定方法は以下】---------------------------

※秘密キーを生成
↓
秘密キーは、暗号化バージョンまたは非暗号化バージョンのいずれかを生成できます。
（非暗号化バージョンを生成）
openssl genrsa 2048 | openssl pkcs8 -topk8 -inform PEM -out rsa_key.p8 -nocrypt

（暗号化バージョンを生成）
openssl genrsa 2048 | openssl pkcs8 -topk8 -v2 des3 -inform PEM -out rsa_key.p8


出力結果イメージ：
-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIE6T...
-----END ENCRYPTED PRIVATE KEY-----


※公開キーを生成
次のコマンドでは、秘密キーが暗号化され、 rsa_key.p8 という名前のファイルに含まれていると仮定

openssl rsa -in rsa_key.p8 -pubout -out rsa_key.pub


出力結果イメージ：
-----BEGIN PUBLIC KEY-----
MIIBIj...
-----END PUBLIC KEY-----


①.Snowflakeユーザーに公開キーを割り当てる

ALTER USER example_user SET RSA_PUBLIC_KEY='MIIBIjANBgkqh...';


※ユーザーの公開キーのフィンガープリントを検証する
※つまり、Snowflake に登録した ユーザーの公開キー が、手元の公開キーと一致しているかを確認します。

1.ユーザーの公開キーのフィンガープリントを取得
DESC USER example_user;
SELECT SUBSTR((SELECT "value" FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))
  WHERE "property" = 'RSA_PUBLIC_KEY_FP'), LEN('SHA256:') + 1);

出力結果イメージ：
Azk1Pq...

③．ローカル（手元）の公開キーからフィンガープリントを作成
次に、手元にある公開キー（例：rsa_key.pub）を使って、同じ方法でフィンガープリントを作成
openssl rsa -pubin -in rsa_key.pub -outform DER | \
openssl dgst -sha256 -binary | \
openssl enc -base64


出力結果イメージ：
writing RSA key
Azk1Pq...


両方の出力を比較
Snowflake の出力
Azk1Pq...
ローカルの出力
Azk1Pq...
 一致していれば公開キーの設定は正しい です。

③.キーペア認証を使用するようにSnowflakeクライアントを設定

1.構成ファイルまたはコマンドラインのいずれかで、秘密キーファイルへのパスを指定
(接続設定に private_key_path 接続パラメーターを追加し、作成した秘密鍵ファイルへのローカルパスを指定します。)

private_key_path = <path>/rsa_key.p8

2.SNOWSQL_PRIVATE_KEY_PASSPHRASE 環境変数を使用して、秘密鍵ファイルを復号化するためのパスフレーズを設定

export SNOWSQL_PRIVATE_KEY_PASSPHRASE=<passphrase> Linux
set SNOWSQL_PRIVATE_KEY_PASSPHRASE='<passphrase>' Windows


3.private-key-path 接続パラメーターを含めて、暗号化された秘密鍵ファイルへのパスを指定
$ snowsql -a <account_identifier> -u <user> --private-key-path <path>/rsa_key.p8


------------------------------------------------------










